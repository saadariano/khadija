<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Magazzino Locale üëï</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f3f4f6;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .modal-container {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: scale(0.95);
            opacity: 0;
            pointer-events: none;
        }

        .modal-container.is-visible {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        /* Print Styles */
        @media print {
            body>*:not(#print-content) {
                display: none;
            }

            #print-content {
                display: block !important;
                width: 100%;
                padding: 1cm;
                margin: 0;
                font-family: 'Poppins', sans-serif;
            }

            #print-content .main-app-card {
                box-shadow: none;
                border: none;
                padding: 0;
            }

            #print-content .print-hide {
                display: none !important;
            }

            #print-content table {
                border-collapse: collapse;
                width: 100%;
                margin-top: 1rem;
            }

            #print-content th,
            #print-content td {
                border: 1px solid #e5e7eb;
                padding: 8px;
                text-align: left;
            }

            #print-content th {
                background-color: #f3f4f6;
                font-weight: 600;
            }

            #print-content h1,
            #print-content h2,
            #print-content h3 {
                color: #1f2937;
            }
        }
    </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="login-container" class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">Benvenuta Khadija</h2>
        <div class="space-y-4">
            <input type="password" id="password" placeholder="Password"
                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
            <button id="login-btn"
                class="w-full bg-purple-600 text-white font-bold py-3 rounded-xl hover:bg-purple-700 transition-colors">
                Accedi
            </button>
        </div>
        <p id="login-message" class="mt-4 text-sm text-red-500"></p>
    </div>

    <div id="main-app-card"
        class="hidden bg-white rounded-3xl shadow-2xl p-8 max-w-6xl w-full flex flex-col lg:flex-row gap-8">

        <div class="flex-1">
            <header class="flex flex-col sm:flex-row justify-between items-center mb-6">
                <div class="mb-4 sm:mb-0">
                    <h1 class="text-3xl font-bold text-gray-800">Gestione Magazzino</h1>
                    <p class="text-sm text-gray-500 mt-1">
                        Utente: <span id="user-id-display" class="font-medium text-purple-600">khadija</span>
                    </p>
                </div>
                <div class="flex items-center space-x-4">
                    <div
                        class="bg-purple-100 text-purple-700 px-4 py-2 rounded-xl text-lg font-semibold flex items-center shadow-inner">
                        <span class="mr-2">Giacenza Totale:</span>
                        <span id="total-stock-count" class="font-bold">0</span>
                    </div>
                    <button id="print-report-btn"
                        class="bg-gray-200 text-gray-700 p-3 rounded-xl shadow-lg hover:bg-gray-300 transition-colors">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M19 8H5C3.34315 8 2 9.34315 2 11V17C2 18.6569 3.34315 20 5 20H19C20.6569 20 22 18.6569 22 17V11C22 9.34315 20.6569 8 19 8ZM5 18C4.44772 18 4 17.5523 4 17V11C4 10.4477 4.44772 10 5 10H19C19.5523 10 20 10.4477 20 11V17C20 17.5523 19.5523 18 19 18H5Z" />
                            <path
                                d="M17 9.5C17.8284 9.5 18.5 8.82843 18.5 8C18.5 7.17157 17.8284 6.5 17 6.5C16.1716 6.5 15.5 7.17157 15.5 8C15.5 8.82843 16.1716 9.5 17 9.5Z" />
                            <path
                                d="M19 4H5C4.44772 4 4 4.44772 4 5V7C4 7.55228 4.44772 8 5 8H19C19.5523 8 20 7.55228 20 7V5C20 4.44772 19.5523 4 19 4Z" />
                        </svg>
                    </button>
                </div>
            </header>

            <section class="mb-8">
                <div class="flex flex-col sm:flex-row items-center justify-between mb-4 gap-4">
                    <div class="relative w-full sm:w-1/3">
                        <input type="text" id="search-input" oninput="renderInventory()"
                            placeholder="Cerca per codice articolo..."
                            class="w-full pl-10 pr-4 py-2 rounded-xl border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all shadow-sm">
                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="currentColor"
                            viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="flex w-full sm:w-auto gap-2">
                        <button id="add-article-btn"
                            class="flex-1 sm:flex-none bg-purple-600 text-white font-semibold py-2 px-6 rounded-xl shadow-lg hover:bg-purple-700 transition-colors">
                            Aggiungi
                        </button>
                        <button id="import-btn"
                            class="flex-1 sm:flex-none bg-green-200 text-green-700 font-semibold py-2 px-6 rounded-xl shadow-lg hover:bg-green-300 transition-colors">
                            Importa
                        </button>
                        <button id="export-btn"
                            class="flex-1 sm:flex-none bg-red-200 text-red-700 font-semibold py-2 px-6 rounded-xl shadow-lg hover:bg-red-300 transition-colors">
                            Esporta
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto bg-gray-50 rounded-2xl shadow-inner border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tl-2xl">
                                    Codice</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Tipo</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Quantit√†</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Ultima Modifica</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider rounded-tr-2xl print-hide">
                                    Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <div
            class="lg:w-96 p-6 bg-gray-50 rounded-3xl shadow-inner border border-gray-200 no-scrollbar overflow-y-auto max-h-[80vh] print-hide">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Cronologia Transazioni ‚è±Ô∏è</h2>
            <div class="flex space-x-2 mb-4">
                <button id="filter-day-btn" data-filter="day"
                    class="history-filter-btn flex-1 py-2 px-4 rounded-xl text-sm font-semibold text-gray-700 bg-white border border-gray-300 shadow hover:bg-gray-100 transition-colors">Giorno</button>
                <button id="filter-month-btn" data-filter="month"
                    class="history-filter-btn flex-1 py-2 px-4 rounded-xl text-sm font-semibold text-gray-700 bg-white border border-gray-300 shadow hover:bg-gray-100 transition-colors">Mese</button>
                <button id="filter-year-btn" data-filter="year"
                    class="history-filter-btn flex-1 py-2 px-4 rounded-xl text-sm font-semibold text-gray-700 bg-white border border-gray-300 shadow hover:bg-gray-100 transition-colors">Anno</button>
            </div>
            <div id="date-picker-container" class="mb-4 hidden">
                <input type="date" id="day-picker"
                    class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring focus:border-blue-300 hidden">
                <input type="month" id="month-picker"
                    class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring focus:border-blue-300 hidden">
                <input type="number" id="year-picker" placeholder="Anno (YYYY)" min="2000"
                    class="w-full px-4 py-2 border rounded-xl focus:outline-none focus:ring focus:border-blue-300 hidden">
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="sticky top-0 bg-gray-50">
                        <tr>
                            <th class="py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tipo</th>
                            <th class="py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Codice</th>
                            <th class="py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Quantit√†</th>
                            <th class="py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Cliente</th>
                            <th class="py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Data</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modals-container">
        <div id="article-modal"
            class="modal-container fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm">
            <div class="bg-white rounded-3xl p-8 max-w-lg w-full shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="article-modal-title" class="text-2xl font-bold text-gray-800">Aggiungi Nuovo Articolo</h3>
                    <button class="modal-close-btn text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="article-form">
                    <input type="hidden" id="article-id">
                    <div class="mb-4">
                        <label for="article-code" class="block text-sm font-semibold text-gray-700 mb-1">Codice
                            Articolo</label>
                        <input type="text" id="article-code" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 transition-all">
                    </div>
                    <div class="mb-4">
                        <label for="article-type" class="block text-sm font-semibold text-gray-700 mb-1">Tipo
                            Articolo</label>
                        <input type="text" id="article-type" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 transition-all">
                    </div>
                    <div class="mb-6">
                        <label for="article-quantity"
                            class="block text-sm font-semibold text-gray-700 mb-1">Quantit√†</label>
                        <input type="number" id="article-quantity" required min="0" value="0"
                            class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 transition-all">
                    </div>
                    <button type="submit"
                        class="w-full bg-purple-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-purple-700 transition-colors">
                        Salva Articolo
                    </button>
                </form>
            </div>
        </div>

        <div id="quantity-modal"
            class="modal-container fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm">
            <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="quantity-modal-title" class="text-2xl font-bold text-gray-800">Modifica Quantit√†</h3>
                    <button class="modal-close-btn text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <form id="quantity-form">
                    <input type="hidden" id="quantity-article-id">
                    <input type="hidden" id="quantity-article-code">
                    <input type="hidden" id="quantity-type-action">
                    <div class="mb-4">
                        <label for="quantity-change-value" class="block text-sm font-semibold text-gray-700 mb-1">Quantit√† da
                            Modificare</label>
                        <input type="number" id="quantity-change-value" required min="1" value="1"
                            class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 transition-all">
                    </div>
                    <div class="mb-6">
                        <label for="client-note-input" class="block text-sm font-semibold text-gray-700 mb-1">Nome Cliente /
                            Nota</label>
                        <input type="text" id="client-note-input"
                            class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 transition-all">
                    </div>
                    <button type="submit"
                        class="w-full bg-purple-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-purple-700 transition-colors">
                        Conferma
                    </button>
                </form>
            </div>
        </div>

        <div id="alert-confirm-modal"
            class="modal-container fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm">
            <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl text-center">
                <h3 id="alert-confirm-title" class="text-xl font-bold text-gray-800 mb-4">Avviso</h3>
                <p id="alert-confirm-message" class="text-gray-600 mb-6">Il messaggio appare qui.</p>
                <div id="alert-confirm-buttons" class="flex justify-center space-x-4">
                    <button id="alert-confirm-ok-btn"
                        class="flex-1 bg-purple-600 text-white font-semibold py-2 px-4 rounded-xl shadow-lg hover:bg-purple-700 transition-colors">
                        OK
                    </button>
                </div>
            </div>
        </div>

        <div id="print-selection-modal"
            class="modal-container fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm">
            <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Seleziona Report</h3>
                    <button class="modal-close-btn text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <p class="text-gray-600 mb-4">Scegli il periodo per il report di stampa:</p>
                <div class="flex flex-col space-y-4">
                    <button data-filter="all"
                        class="print-option-btn w-full bg-purple-600 text-white font-semibold py-2 px-6 rounded-xl shadow-lg hover:bg-purple-700 transition-colors">Tutto
                        l'Inventario</button>
                    <button data-filter="all-transactions"
                        class="print-option-btn w-full bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-xl shadow-lg hover:bg-gray-300 transition-colors">Tutte le Transazioni</button>
                    <button data-filter="day"
                        class="print-option-btn w-full bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-xl shadow-lg hover:bg-gray-300 transition-colors">Transazioni
                        del Giorno</button>
                    <button data-filter="week"
                        class="print-option-btn w-full bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-xl shadow-lg hover:bg-gray-300 transition-colors">Transazioni
                        della Settimana</button>
                    <button data-filter="month"
                        class="print-option-btn w-full bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-xl shadow-lg hover:bg-gray-300 transition-colors">Transazioni
                        del Mese</button>
                    <button data-filter="year"
                        class="print-option-btn w-full bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-xl shadow-lg hover:bg-gray-300 transition-colors">Transazioni
                        dell'Anno</button>
                </div>
            </div>
        </div>
        <div id="date-selection-modal"
            class="modal-container fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm">
            <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="date-modal-title" class="text-2xl font-bold text-gray-800">Seleziona Data</h3>
                    <button class="modal-close-btn text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="mb-4">
                    <label for="modal-date-input" class="block text-sm font-semibold text-gray-700 mb-1">Seleziona
                        una data:</label>
                    <input type="date" id="modal-date-input"
                        class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 transition-all">
                    <input type="month" id="modal-month-input"
                        class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 transition-all hidden">
                    <input type="number" id="modal-year-input" placeholder="Anno (YYYY)" min="2000"
                        class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 transition-all hidden">
                </div>
                <button id="filter-date-btn"
                    class="w-full bg-purple-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-purple-700 transition-colors">
                    Filtra
                </button>
            </div>
        </div>
    </div>

    <div id="print-content" class="hidden"></div>

    <script>
        const LOGIN_PASSWORD = '310';
        let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];

        function saveDataToLocalStorage() {
            localStorage.setItem('inventory', JSON.stringify(inventory));
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }

        function showModal(modalId, title = '', message = '') {
            const modal = document.getElementById(modalId);
            const titleEl = modal.querySelector('#alert-confirm-title');
            const messageEl = modal.querySelector('#alert-confirm-message');
            if (titleEl) titleEl.textContent = title;
            if (messageEl) messageEl.textContent = message;
            modal.classList.add('is-visible');
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('is-visible');
        }

        function showAlert(title, message) {
            showModal('alert-confirm-modal', title, message);
        }

        // --- Authentication Logic ---
        function handleLogin() {
            const password = document.getElementById('password').value;
            const loginMessage = document.getElementById('login-message');

            if (password === LOGIN_PASSWORD) {
                localStorage.setItem('isAuthenticated', 'true');
                document.getElementById('login-container').classList.add('hidden');
                document.getElementById('main-app-card').classList.remove('hidden');
                refreshUI();
            } else {
                loginMessage.textContent = 'Credenziali non valide.';
            }
        }

        function checkAuthentication() {
            if (localStorage.getItem('isAuthenticated') === 'true') {
                document.getElementById('login-container').classList.add('hidden');
                document.getElementById('main-app-card').classList.remove('hidden');
                refreshUI();
            } else {
                document.getElementById('login-container').classList.remove('hidden');
                document.getElementById('main-app-card').classList.add('hidden');
            }
        }

        function handleLogout() {
            localStorage.removeItem('isAuthenticated');
            checkAuthentication();
        }

        window.addEventListener('beforeunload', handleLogout);

        // --- Rendering Functions ---
        function renderInventory() {
            const tableBody = document.getElementById('inventory-table-body');
            const totalStockCounter = document.getElementById('total-stock-count');
            const searchInput = document.getElementById('search-input');
            const searchQuery = searchInput.value.toLowerCase();

            const filteredInventory = inventory
                .filter(item => item.code.toLowerCase().includes(searchQuery))
                .sort((a, b) => a.code.localeCompare(b.code));

            tableBody.innerHTML = '';
            let totalStock = 0;

            if (filteredInventory.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="5" class="py-4 text-center text-gray-500">Nessun articolo trovato.</td>`;
                tableBody.appendChild(row);
            } else {
                filteredInventory.forEach(item => {
                    totalStock += item.quantity;
                    const date = new Date(item.lastModified);
                    const formattedDate = date.toLocaleString('it-IT', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-800">${item.code}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-700">${item.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500">${formattedDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium print-hide">
                            <div class="flex items-center gap-2">
                                <button data-id="${item.id}" data-action="add" class="action-btn text-green-600 hover:text-green-900 transition-colors rounded-full p-1">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                  </svg>
                                </button>
                                <button data-id="${item.id}" data-action="consume" class="action-btn text-red-600 hover:text-red-900 transition-colors rounded-full p-1">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                  </svg>
                                </button>
                                <button data-id="${item.id}" data-action="edit" class="action-btn text-blue-600 hover:text-blue-900 transition-colors rounded-full p-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.932ZM12.5 10.5H12a2 2 0 01-2-2V7.5" />
                                    </svg>
                                </button>
                                <button data-id="${item.id}" data-action="delete" class="action-btn text-gray-400 hover:text-gray-600 transition-colors rounded-full p-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.013 21H7.987a2 2 0 01-1.92-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            totalStockCounter.textContent = totalStock;
        }

        function renderTransactions(filter = 'day', specificDate) {
            const tableBody = document.getElementById('transactions-table-body');
            tableBody.innerHTML = '';

            let sortedTransactions = [...transactions].sort((a, b) => b.timestamp - a.timestamp);
            let filteredTransactions = sortedTransactions;

            if (specificDate) {
                const selectedDate = new Date(specificDate);
                // Ensure date is treated as local date for consistent filtering
                selectedDate.setHours(0, 0, 0, 0);

                if (filter === 'day') {
                    filteredTransactions = sortedTransactions.filter(t => {
                        const transactionDate = new Date(t.timestamp);
                        transactionDate.setHours(0, 0, 0, 0); // Normalize to start of day
                        return transactionDate.getTime() === selectedDate.getTime();
                    });
                } else if (filter === 'month') {
                    filteredTransactions = sortedTransactions.filter(t => {
                        const transactionDate = new Date(t.timestamp);
                        return transactionDate.getMonth() === selectedDate.getMonth() &&
                            transactionDate.getFullYear() === selectedDate.getFullYear();
                    });
                } else if (filter === 'year') {
                    filteredTransactions = sortedTransactions.filter(t => {
                        const transactionDate = new Date(t.timestamp);
                        return transactionDate.getFullYear() === selectedDate.getFullYear();
                    });
                }
            } else {
                const now = new Date();
                now.setHours(0, 0, 0, 0); // Normalize 'now' to start of day for consistency

                filteredTransactions = sortedTransactions.filter(t => {
                    const transactionDate = new Date(t.timestamp);
                    transactionDate.setHours(0, 0, 0, 0); // Normalize transaction date to start of day

                    if (filter === 'day') {
                        return transactionDate.getTime() === now.getTime();
                    }
                    if (filter === 'month') {
                        return transactionDate.getMonth() === now.getMonth() &&
                            transactionDate.getFullYear() === now.getFullYear();
                    }
                    if (filter === 'year') {
                        return transactionDate.getFullYear() === now.getFullYear();
                    }
                    return true; // 'all' filter, or no specific date
                });
            }

            if (filteredTransactions.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="5" class="py-4 text-center text-gray-500">Nessuna transazione trovata per questo periodo.</td>`;
                tableBody.appendChild(row);
            } else {
                filteredTransactions.forEach(t => {
                    const date = new Date(t.timestamp);
                    const formattedDate = date.toLocaleString('it-IT', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    let tipo;
                    let colorClass = '';
                    let fontWeightClass = 'font-medium';
                    let sign = '';

                    switch (t.type) {
                        case 'nuovo':
                            tipo = 'Nuovo';
                            colorClass = 'text-blue-600';
                            break;
                        case 'aggiungi':
                            tipo = 'Aggiunta';
                            colorClass = 'text-green-600';
                            sign = '+';
                            break;
                        case 'consumo':
                            tipo = 'Consumo';
                            colorClass = 'text-red-600';
                            sign = '-';
                            break;
                        case 'modifica':
                            tipo = 'Modifica';
                            colorClass = 'text-yellow-600';
                            break;
                        case 'rimuovi':
                            tipo = 'Rimozione';
                            colorClass = 'text-red-800';
                            fontWeightClass = 'font-bold';
                            break;
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="py-2 text-xs ${fontWeightClass} ${colorClass}">${tipo}</td>
                        <td class="py-2 text-xs text-gray-700">${t.code}</td>
                        <td class="py-2 text-xs ${fontWeightClass} ${colorClass}">${sign}${t.quantity}</td>
                        <td class="py-2 text-xs text-gray-600 font-bold">${t.client || '-'}</td>
                        <td class="py-2 text-xs text-gray-500">${formattedDate}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        }

        // --- Data Manipulation Functions ---
        function handleAddEditArticle(e) {
            e.preventDefault();
            const id = document.getElementById('article-id').value;
            const code = document.getElementById('article-code').value.toUpperCase();
            const type = document.getElementById('article-type').value;
            const quantity = parseInt(document.getElementById('article-quantity').value);

            if (id) {
                // Edit existing article
                const index = inventory.findIndex(item => item.id === id);
                if (index !== -1) {
                    const oldQuantity = inventory[index].quantity;
                    const change = quantity - oldQuantity;
                    inventory[index].code = code;
                    inventory[index].type = type;
                    inventory[index].quantity = quantity;
                    inventory[index].lastModified = Date.now();
                    if (change !== 0) {
                        transactions.push({
                            id: crypto.randomUUID(),
                            code: code,
                            type: 'modifica',
                            quantity: change,
                            client: 'N/A',
                            timestamp: Date.now()
                        });
                    }
                }
            } else {
                // Add new article
                const existingArticle = inventory.find(item => item.code.toUpperCase() === code);
                if (existingArticle) {
                    showAlert('Articolo Esistente', 'Un articolo con questo codice esiste gi√†. Usa la funzione "Aggiungi" per incrementare la quantit√†.');
                    return;
                }
                const newArticle = {
                    id: crypto.randomUUID(),
                    code,
                    type,
                    quantity,
                    lastModified: Date.now()
                };
                inventory.push(newArticle);
                if (quantity > 0) {
                    transactions.push({
                        id: crypto.randomUUID(),
                        code: newArticle.code,
                        type: 'nuovo',
                        quantity,
                        client: 'N/A',
                        timestamp: Date.now()
                    });
                }
            }
            saveDataToLocalStorage();
            refreshUI();
            hideModal('article-modal');
        }

        function handleQuantityChange(e) {
            e.preventDefault();
            const id = document.getElementById('quantity-article-id').value;
            const action = document.getElementById('quantity-type-action').value;
            const changeValue = parseInt(document.getElementById('quantity-change-value').value);
            const clientNote = document.getElementById('client-note-input').value;
            const item = inventory.find(i => i.id === id);

            if (!item) {
                showAlert('Errore', 'Articolo non trovato.');
                return;
            }

            let newQuantity;
            let transactionType;
            let transactionQuantity;

            if (action === 'add') {
                newQuantity = item.quantity + changeValue;
                transactionType = 'aggiungi';
                transactionQuantity = changeValue;
            } else if (action === 'consume') {
                newQuantity = item.quantity - changeValue;
                if (newQuantity < 0) {
                    showAlert('Errore', 'La quantit√† non pu√≤ essere negativa.');
                    return;
                }
                transactionType = 'consumo';
                transactionQuantity = changeValue;
            } else {
                return;
            }

            item.quantity = newQuantity;
            item.lastModified = Date.now();

            transactions.push({
                id: crypto.randomUUID(),
                code: item.code,
                type: transactionType,
                quantity: transactionQuantity,
                client: clientNote || 'N/A',
                timestamp: Date.now()
            });

            saveDataToLocalStorage();
            refreshUI();
            hideModal('quantity-modal');
        }

        function handleDeleteArticle(id) {
            const confirmed = window.confirm('Sei sicuro di voler rimuovere questo articolo? Questa azione non pu√≤ essere annullata.');
            if (confirmed) {
                const item = inventory.find(i => i.id === id);
                if (item) {
                    // Add a transaction for the deletion
                    transactions.push({
                        id: crypto.randomUUID(),
                        code: item.code,
                        type: 'rimuovi',
                        quantity: item.quantity,
                        client: 'N/A',
                        timestamp: Date.now()
                    });
                }
                inventory = inventory.filter(item => item.id !== id);
                saveDataToLocalStorage();
                refreshUI();
            }
        }

        // --- Import/Export Functions ---
        function exportData() {
            const data = {
                inventory: inventory,
                transactions: transactions
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `magazzino_backup_${new Date().toISOString().substring(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showAlert('Esportazione Completata', 'I dati sono stati esportati correttamente.');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        try {
                            const importedData = JSON.parse(event.target.result);
                            if (importedData.inventory && importedData.transactions) {
                                // Optional: Ask for confirmation before overwriting
                                const confirmImport = confirm('Sei sicuro di voler importare questi dati? I dati attuali verranno sovrascritti.');
                                if (confirmImport) {
                                    inventory = importedData.inventory;
                                    transactions = importedData.transactions;
                                    saveDataToLocalStorage();
                                    refreshUI();
                                    showAlert('Importazione Completata', 'I dati sono stati importati correttamente.');
                                }
                            } else {
                                throw new Error('File JSON non valido: mancano le chiavi "inventory" o "transactions".');
                            }
                        } catch (error) {
                            showAlert('Errore di Importazione', 'Impossibile leggere il file JSON: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            document.getElementById('add-article-btn').addEventListener('click', () => {
                const form = document.getElementById('article-form');
                form.reset();
                document.getElementById('article-modal-title').textContent = 'Aggiungi Nuovo Articolo';
                document.getElementById('article-id').value = '';
                showModal('article-modal');
            });
            document.getElementById('article-form').addEventListener('submit', handleAddEditArticle);
            document.getElementById('quantity-form').addEventListener('submit', handleQuantityChange);
            document.getElementById('alert-confirm-ok-btn').addEventListener('click', () => hideModal('alert-confirm-modal'));
            document.querySelectorAll('.modal-close-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const modal = e.target.closest('.modal-container');
                    if (modal) {
                        hideModal(modal.id);
                    }
                });
            });

            document.getElementById('inventory-table-body').addEventListener('click', (e) => {
                const button = e.target.closest('.action-btn');
                if (!button) return;
                const id = button.dataset.id;
                const action = button.dataset.action;

                if (action === 'edit') {
                    const item = inventory.find(i => i.id === id);
                    if (item) {
                        document.getElementById('article-modal-title').textContent = 'Modifica Articolo';
                        document.getElementById('article-id').value = item.id;
                        document.getElementById('article-code').value = item.code;
                        document.getElementById('article-type').value = item.type;
                        document.getElementById('article-quantity').value = item.quantity;
                        showModal('article-modal');
                    }
                } else if (action === 'delete') {
                    handleDeleteArticle(id);
                } else if (action === 'add' || action === 'consume') {
                    const item = inventory.find(i => i.id === id);
                    if (item) {
                        document.getElementById('quantity-modal-title').textContent = action === 'add' ? 'Aggiungi Quantit√†' : 'Consuma Quantit√†';
                        document.getElementById('quantity-article-id').value = item.id;
                        document.getElementById('quantity-article-code').value = item.code;
                        document.getElementById('quantity-type-action').value = action;
                        document.getElementById('quantity-change-value').value = 1;
                        showModal('quantity-modal');
                    }
                }
            });

            document.querySelectorAll('.history-filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.history-filter-btn').forEach(b => {
                        b.style.backgroundColor = '';
                    });

                    const filter = e.target.dataset.filter;
                    let datePickerContainer = document.getElementById('date-picker-container');
                    let dayPicker = document.getElementById('day-picker');
                    let monthPicker = document.getElementById('month-picker');
                    let yearPicker = document.getElementById('year-picker');

                    // Hide all pickers and clear current active state
                    [dayPicker, monthPicker, yearPicker].forEach(p => p.classList.add('hidden'));
                    datePickerContainer.classList.remove('hidden'); // Show container

                    e.target.style.backgroundColor = '#d1fae5'; // Set to light green

                    const now = new Date();
                    const year = now.getFullYear();
                    const month = (now.getMonth() + 1).toString().padStart(2, '0');
                    const day = now.getDate().toString().padStart(2, '0');

                    if (filter === 'day') {
                        dayPicker.classList.remove('hidden');
                        dayPicker.value = `${year}-${month}-${day}`;
                        dayPicker.onchange = (e) => renderTransactions('day', e.target.value);
                        renderTransactions('day', dayPicker.value);
                    } else if (filter === 'month') {
                        monthPicker.classList.remove('hidden');
                        monthPicker.value = `${year}-${month}`;
                        monthPicker.onchange = (e) => renderTransactions('month', e.target.value + '-01');
                        renderTransactions('month', monthPicker.value + '-01');
                    } else if (filter === 'year') {
                        yearPicker.classList.remove('hidden');
                        yearPicker.value = year;
                        yearPicker.oninput = (e) => renderTransactions('year', e.target.value + '-01-01');
                        renderTransactions('year', yearPicker.value + '-01-01');
                    } else {
                        datePickerContainer.classList.add('hidden'); // Hide container if no specific filter
                        renderTransactions('all'); // Fallback or clear filter logic
                    }
                });
            });

            document.getElementById('print-report-btn').addEventListener('click', () => {
                showModal('print-selection-modal');
            });

            let currentPrintFilter = '';
            document.querySelectorAll('.print-option-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    currentPrintFilter = e.target.dataset.filter;
                    hideModal('print-selection-modal');

                    if (currentPrintFilter === 'all' || currentPrintFilter === 'all-transactions') {
                        printReport(currentPrintFilter);
                    } else {
                        // Show date selection modal
                        const dateModal = document.getElementById('date-selection-modal');
                        const dateInput = document.getElementById('modal-date-input');
                        const monthInput = document.getElementById('modal-month-input');
                        const yearInput = document.getElementById('modal-year-input');

                        // Reset visibility
                        dateInput.classList.add('hidden');
                        monthInput.classList.add('hidden');
                        yearInput.classList.add('hidden');

                        const now = new Date();
                        const year = now.getFullYear();
                        const month = (now.getMonth() + 1).toString().padStart(2, '0');
                        const day = now.getDate().toString().padStart(2, '0');


                        if (currentPrintFilter === 'day' || currentPrintFilter === 'week') {
                            document.getElementById('date-modal-title').textContent = 'Seleziona Data';
                            dateInput.classList.remove('hidden');
                            dateInput.value = `${year}-${month}-${day}`;
                        } else if (currentPrintFilter === 'month') {
                            document.getElementById('date-modal-title').textContent = 'Seleziona Mese';
                            monthInput.classList.remove('hidden');
                            monthInput.value = `${year}-${month}`;
                        } else if (currentPrintFilter === 'year') {
                            document.getElementById('date-modal-title').textContent = 'Seleziona Anno';
                            yearInput.classList.remove('hidden');
                            yearInput.value = year;
                        }
                        showModal('date-selection-modal');
                    }
                });
            });

            document.getElementById('filter-date-btn').addEventListener('click', () => {
                let selectedDateValue;
                let dateType = 'day'; // Default for day/week filter

                const dateInput = document.getElementById('modal-date-input');
                const monthInput = document.getElementById('modal-month-input');
                const yearInput = document.getElementById('modal-year-input');

                if (!dateInput.classList.contains('hidden')) {
                    selectedDateValue = dateInput.value;
                } else if (!monthInput.classList.contains('hidden')) {
                    selectedDateValue = monthInput.value + '-01'; // Add day for Date constructor
                    dateType = 'month';
                } else if (!yearInput.classList.contains('hidden')) {
                    selectedDateValue = yearInput.value + '-01-01'; // Add month/day for Date constructor
                    dateType = 'year';
                }

                if (selectedDateValue) {
                    printReport(currentPrintFilter, selectedDateValue);
                    hideModal('date-selection-modal');
                } else {
                    showAlert('Errore', 'Seleziona una data valida.');
                }
            });

            // Import and Export button listeners
            document.getElementById('import-btn').addEventListener('click', importData);
            document.getElementById('export-btn').addEventListener('click', exportData);

            // Initial transaction filter to "Giorno"
            document.getElementById('filter-day-btn').click();
        }

        function printReport(filter, specificDate) {
            let contentToPrint = '';
            let title = '';
            const printContentEl = document.getElementById('print-content');

            if (filter === 'all') {
                title = 'Report Inventario Completo';
                contentToPrint = `
                    <h1 class="text-3xl font-bold mb-4">${title}</h1>
                    <p class="mb-4">Data Stampa: ${new Date().toLocaleString('it-IT')}</p>
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th>Codice</th>
                                <th>Tipo</th>
                                <th>Quantit√†</th>
                                <th>Ultima Modifica</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${inventory.map(item => `
                                <tr>
                                    <td>${item.code}</td>
                                    <td>${item.type}</td>
                                    <td>${item.quantity}</td>
                                    <td>${new Date(item.lastModified).toLocaleString('it-IT')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (filter === 'all-transactions') {
                title = 'Report Transazioni Complete';
                const sortedTransactions = [...transactions].sort((a, b) => a.timestamp - b.timestamp);
                contentToPrint = `
                    <h1 class="text-3xl font-bold mb-4">${title}</h1>
                    <p class="mb-4">Data Stampa: ${new Date().toLocaleString('it-IT')}</p>
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Codice</th>
                                <th>Quantit√†</th>
                                <th>Cliente</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedTransactions.map(t => `
                                <tr>
                                    <td>${t.type === 'aggiungi' ? 'Aggiunta' : t.type === 'consumo' ? 'Consumo' : t.type === 'nuovo' ? 'Nuovo' : t.type === 'modifica' ? 'Modifica' : 'Rimozione'}</td>
                                    <td>${t.code}</td>
                                    <td>${t.quantity}</td>
                                    <td>${t.client}</td>
                                    <td>${new Date(t.timestamp).toLocaleString('it-IT')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                let filteredTransactions = [];
                const printDate = specificDate ? new Date(specificDate) : new Date();
                printDate.setHours(0, 0, 0, 0); // Normalize for consistent filtering

                const sortedTransactions = [...transactions].sort((a, b) => b.timestamp - a.timestamp);

                if (filter === 'day') {
                    title = 'Report Transazioni del Giorno';
                    filteredTransactions = sortedTransactions.filter(t => {
                        const transactionDate = new Date(t.timestamp);
                        transactionDate.setHours(0, 0, 0, 0);
                        return transactionDate.getTime() === printDate.getTime();
                    });
                    title += ` (${printDate.toLocaleDateString('it-IT')})`;
                } else if (filter === 'week') {
                    title = 'Report Transazioni della Settimana';
                    const startOfWeek = new Date(printDate);
                    startOfWeek.setDate(printDate.getDate() - (printDate.getDay() + 6) % 7);
                    startOfWeek.setHours(0, 0, 0, 0);
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 7); // Exclusive end

                    filteredTransactions = sortedTransactions.filter(t => {
                        const transactionDate = new Date(t.timestamp);
                        transactionDate.setHours(0, 0, 0, 0);
                        return transactionDate >= startOfWeek && transactionDate < endOfWeek;
                    });
                    title += ` (Settimana di ${startOfWeek.toLocaleDateString('it-IT')})`;
                } else if (filter === 'month') {
                    title = 'Report Transazioni del Mese';
                    filteredTransactions = sortedTransactions.filter(t => {
                        const transactionDate = new Date(t.timestamp);
                        return transactionDate.getMonth() === printDate.getMonth() &&
                            transactionDate.getFullYear() === printDate.getFullYear();
                    });
                    title += ` (${printDate.toLocaleString('it-IT', { month: 'long', year: 'numeric' })})`;
                } else if (filter === 'year') {
                    title = 'Report Transazioni dell\'Anno';
                    filteredTransactions = sortedTransactions.filter(t => {
                        const transactionDate = new Date(t.timestamp);
                        return transactionDate.getFullYear() === printDate.getFullYear();
                    });
                    title += ` (${printDate.getFullYear()})`;
                }

                if (filteredTransactions.length === 0) {
                    contentToPrint = `
                        <h1 class="text-3xl font-bold mb-4">${title}</h1>
                        <p class="mb-4">Data Stampa: ${new Date().toLocaleString('it-IT')}</p>
                        <p class="text-gray-600">Nessuna transazione trovata per il periodo selezionato.</p>
                    `;
                } else {
                    contentToPrint = `
                        <h1 class="text-3xl font-bold mb-4">${title}</h1>
                        <p class="mb-4">Data Stampa: ${new Date().toLocaleString('it-IT')}</p>
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Codice</th>
                                    <th>Quantit√†</th>
                                    <th>Cliente</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredTransactions.map(t => `
                                    <tr>
                                        <td>${t.type === 'aggiungi' ? 'Aggiunta' : t.type === 'consumo' ? 'Consumo' : t.type === 'nuovo' ? 'Nuovo' : t.type === 'modifica' ? 'Modifica' : 'Rimozione'}</td>
                                        <td>${t.code}</td>
                                        <td>${t.quantity}</td>
                                        <td>${t.client}</td>
                                        <td>${new Date(t.timestamp).toLocaleString('it-IT')}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            }

            printContentEl.innerHTML = contentToPrint;
            window.print();
        }

        function refreshUI() {
            renderInventory();
            // Re-click the day filter button to ensure it's active and showing today's transactions by default
            document.getElementById('filter-day-btn').click();
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthentication();
            setupEventListeners();
        });
    </script>
</body>

</html>